generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model AgentProject {
  id             String    @id @default(cuid())
  name           String
  slug           String    @unique
  description    String    @default("")
  status         String    @default("draft")
  config         String    @default("{}")
  stages         String    @default("{}")
  conversations  String    @default("{}")
  templateId     String?
  lettaAgentId   String?   // Letta agent ID when deployed to Letta runtime
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  exportedAt     DateTime?

  deployments    Deployment[]
  mcpServers     McpServerConfig[]
}

model AgentTemplate {
  id          String @id @default(cuid())
  name        String
  description String
  category    String
  config      String
  stages      String
}

model Deployment {
  id            String        @id @default(cuid())
  agentId       String
  version       Int           @default(1)
  config        String        // Frozen AgentConfig snapshot (JSON string)
  systemPrompt  String        // Pre-built runtime system prompt
  mcpConfig     String        @default("[]") // Frozen MCP server config snapshot (JSON string)
  lettaAgentId  String?       // Letta agent ID for this deployment version
  status        String        @default("active") // "active" | "paused" | "retired"
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  agent         AgentProject  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  sessions      ChatSession[]
  toolLogs      ToolExecutionLog[]

  @@index([agentId])
}

model ChatSession {
  id             String      @id @default(cuid())
  deploymentId   String
  token          String      @unique
  messages       String      @default("[]")  // JSON array of RuntimeMessage[]
  turnCount      Int         @default(0)
  failedAttempts Int         @default(0)
  status         String      @default("active") // "active" | "ended" | "escalated"
  metadata       String      @default("{}")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  deployment     Deployment  @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  toolLogs       ToolExecutionLog[]

  @@index([deploymentId])
  @@index([token])
}

model McpServerConfig {
  id            String       @id @default(cuid())
  agentId       String
  name          String       // Human-readable server name (e.g. "filesystem", "jira-cloud")
  transport     String       // "stdio" | "sse" | "http"
  command       String?      // For stdio: the command to run
  args          String       @default("[]") // JSON array of command arguments
  url           String?      // For sse/http: the endpoint URL
  env           String       @default("{}") // JSON object of environment variables
  allowedTools  String       @default("[]") // JSON array of allowed tool name patterns
  blockedTools  String       @default("[]") // JSON array of blocked tool name patterns
  sandboxConfig String       @default("{}") // JSON SandboxConfig
  status        String       @default("active") // "active" | "inactive"
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  agent         AgentProject @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, name])
  @@index([agentId])
}

model ToolExecutionLog {
  id            String       @id @default(cuid())
  sessionId     String?
  deploymentId  String
  toolName      String
  serverName    String
  input         String       @default("{}") // JSON tool input
  output        String       @default("{}") // JSON tool output
  isError       Boolean      @default(false)
  durationMs    Int          @default(0)
  createdAt     DateTime     @default(now())

  session       ChatSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  deployment    Deployment   @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([deploymentId])
  @@index([toolName])
}

