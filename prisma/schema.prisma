generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model AgentProject {
  id             String    @id @default(cuid())
  name           String
  slug           String    @unique
  description    String    @default("")
  status         String    @default("draft")
  config         String    @default("{}")
  stages         String    @default("{}")
  conversations  String    @default("{}")
  templateId     String?
  lettaAgentId   String?   // Letta agent ID when deployed to Letta runtime
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  exportedAt     DateTime?

  deployments    Deployment[]
  mcpServers     McpServerConfig[]
  teamMemberships TeamMembership[]
}

model AgentTemplate {
  id          String @id @default(cuid())
  name        String
  description String
  category    String
  config      String
  stages      String
}

model Deployment {
  id            String        @id @default(cuid())
  agentId       String
  version       Int           @default(1)
  config        String        // Frozen AgentConfig snapshot (JSON string)
  systemPrompt  String        // Pre-built runtime system prompt
  mcpConfig     String        @default("[]") // Frozen MCP server config snapshot (JSON string)
  lettaAgentId  String?       // Letta agent ID for this deployment version
  status        String        @default("active") // "active" | "paused" | "retired"
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  agent         AgentProject  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  sessions      ChatSession[]
  toolLogs      ToolExecutionLog[]

  @@index([agentId])
}

model ChatSession {
  id             String      @id @default(cuid())
  deploymentId   String
  token          String      @unique
  messages       String      @default("[]")  // JSON array of RuntimeMessage[]
  turnCount      Int         @default(0)
  failedAttempts Int         @default(0)
  status         String      @default("active") // "active" | "ended" | "escalated"
  metadata       String      @default("{}")
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  deployment     Deployment  @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  toolLogs       ToolExecutionLog[]

  @@index([deploymentId])
  @@index([token])
}

model McpServerConfig {
  id            String       @id @default(cuid())
  agentId       String
  name          String       // Human-readable server name (e.g. "filesystem", "jira-cloud")
  transport     String       // "stdio" | "sse" | "http"
  command       String?      // For stdio: the command to run
  args          String       @default("[]") // JSON array of command arguments
  url           String?      // For sse/http: the endpoint URL
  env           String       @default("{}") // JSON object of environment variables
  allowedTools  String       @default("[]") // JSON array of allowed tool name patterns
  blockedTools  String       @default("[]") // JSON array of blocked tool name patterns
  sandboxConfig String       @default("{}") // JSON SandboxConfig
  status        String       @default("active") // "active" | "inactive"
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  agent         AgentProject @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, name])
  @@index([agentId])
}

model ToolExecutionLog {
  id            String       @id @default(cuid())
  sessionId     String?
  deploymentId  String
  toolName      String
  serverName    String
  input         String       @default("{}") // JSON tool input
  output        String       @default("{}") // JSON tool output
  isError       Boolean      @default(false)
  durationMs    Int          @default(0)
  createdAt     DateTime     @default(now())

  session       ChatSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  deployment    Deployment   @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([deploymentId])
  @@index([toolName])
}

// ── Multi-Agent Teams ─────────────────────────────────────────────

model AgentTeam {
  id                    String           @id @default(cuid())
  name                  String
  slug                  String           @unique
  description           String           @default("")
  orchestrationConfig   String           @default("{}") // JSON: orchestration mode, pipeline stages, etc.
  status                String           @default("draft") // "draft" | "active" | "archived"
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  members               TeamMembership[]
  projects              TeamProject[]
}

model TeamMembership {
  id            String       @id @default(cuid())
  teamId        String
  agentId       String
  role          String       @default("member") // "orchestrator" | "member"
  lettaAgentId  String?      // Letta agent ID when deployed as part of team
  createdAt     DateTime     @default(now())

  team          AgentTeam    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  agent         AgentProject @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([teamId, agentId])
  @@index([teamId])
  @@index([agentId])
}

model TeamProject {
  id            String     @id @default(cuid())
  teamId        String
  name          String
  brief         String     @default("")
  status        String     @default("active") // "active" | "completed" | "archived"
  lettaBlockIds String     @default("{}") // JSON: { project, decisions, taskBoard, brand } block IDs
  activityLog   String     @default("[]") // JSON array of activity entries
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  team          AgentTeam  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tasks         Task[]
  artifacts     Artifact[]

  @@index([teamId])
}

model Task {
  id              String       @id @default(cuid())
  teamProjectId   String?
  agentId         String?      // Standalone agent task (outside team context)
  title           String
  description     String       @default("")
  status          String       @default("pending") // "pending" | "in_progress" | "done" | "blocked"
  assignedTo      String?      // Agent ID or name
  metadata        String       @default("{}") // JSON for extra data
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  teamProject     TeamProject? @relation(fields: [teamProjectId], references: [id], onDelete: Cascade)
  artifacts       Artifact[]

  @@index([teamProjectId])
  @@index([agentId])
}

model Artifact {
  id              String       @id @default(cuid())
  agentId         String?      // Which agent produced it
  taskId          String?
  teamProjectId   String?
  type            String       // "wireframe" | "code" | "copy" | "design" | "document" | "other"
  name            String
  content         String       @default("") // Full content (Markdown + YAML frontmatter)
  path            String?      // File path if stored on disk
  url             String?      // URL if hosted
  metadata        String       @default("{}") // JSON for extra data
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  task            Task?        @relation(fields: [taskId], references: [id], onDelete: SetNull)
  teamProject     TeamProject? @relation(fields: [teamProjectId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([taskId])
  @@index([teamProjectId])
}
